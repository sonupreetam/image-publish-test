# Publish Image Workflow
# ======================
# Builds, scans, and pushes container image to GHCR.

name: Publish Image to GHCR

on:
  push:
    branches:
      - '**'
    paths:
      - 'Containerfile'
      - '.github/workflows/publish_image_test.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'Containerfile'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild without cache'
        required: false
        default: false
        type: boolean
      enable_trivy_source:
        description: 'Enable Trivy source scan (secrets + misconfig)'
        default: true
        type: boolean
      enable_trivy_image:
        description: 'Enable Trivy image scan'
        default: true
        type: boolean

# Prevent concurrent builds for the same branch
concurrency:
  group: publish-image-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # Step 0: VALIDATE INPUTS
  # ═══════════════════════════════════════════════════════════════════════════
  validate:
    name: Validate Inputs
    runs-on: ubuntu-latest
    steps:
      - name: Validate image name format
        env:
          IMAGE_NAME: ${{ github.repository }}
        run: |
          # Validate image name format (org/name)
          if ! echo "$IMAGE_NAME" | grep -qE '^[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+$'; then
            echo "::error::Invalid image_name format. Expected 'org/name', got '$IMAGE_NAME'."
            exit 1
          fi
          echo "✓ Image name format valid: $IMAGE_NAME"

  # ═══════════════════════════════════════════════════════════════════════════
  # Step 1: PRE-BUILD SOURCE SCANNING (shift-left security)
  # ═══════════════════════════════════════════════════════════════════════════
  # Catches vulnerabilities BEFORE building—fail fast, save CI time.
  scan-source:
    name: Pre-build Source Scan
    needs: [validate]
    permissions:
      contents: read
      actions: read
      packages: write
      security-events: write
      id-token: write
    uses: sonupreetam/org-infra-tests/.github/workflows/reusable_vuln_scan.yml@main
    with:
      enable_osv: true
      enable_trivy_source: true
      enable_trivy_image: false
      trivy_severity: HIGH,CRITICAL
    secrets: inherit

  # ═══════════════════════════════════════════════════════════════════════════
  # Step 2: BUILD AND PUSH (only if source scan passes)
  # ═══════════════════════════════════════════════════════════════════════════
  publish-image:
    needs: [scan-source]
    name: Build and Push Image
    # Required permissions for the reusable workflow
    permissions:
      contents: read
      packages: write
      actions: read
    uses: sonupreetam/org-infra-tests/.github/workflows/reusable_push_ghcr.yml@main
    with:
      component_name: 'image-publish-test'
      containerfile_path: 'Containerfile'
      context_path: '.'
      image_name: '${{ github.repository }}'

      image_description: 'Image publish test container'
      image_vendor: 'sonu'
      force_rebuild: ${{ inputs.force_rebuild || false }}
    secrets: inherit

  # ═══════════════════════════════════════════════════════════════════════════
  # Step 3: POST-BUILD IMAGE SCANNING
  # ═══════════════════════════════════════════════════════════════════════════
  # Scans the built image for OS package vulns, runtime deps, embedded secrets.
  scan-image:
    name: Post-build Image Scan
    needs: [publish-image]
    if: ${{ always() && needs.publish-image.result == 'success' }}
    permissions:
      contents: read
      actions: read
      packages: write
      security-events: write
      id-token: write
    uses: sonupreetam/org-infra-tests/.github/workflows/reusable_vuln_scan.yml@main
    with:
      enable_osv: false
      enable_trivy_source: false
      enable_trivy_image: true
      image_ref: ${{ needs.publish-image.outputs.image }}:sha-${{ github.sha }}
      image_digest: ${{ needs.publish-image.outputs.digest }}
      trivy_severity: HIGH,CRITICAL
    secrets: inherit
