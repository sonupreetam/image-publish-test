# Multi-Component Image Pipeline (Test)
# ==================================
# validate â†’ scan-source â†’ build â†’ scan-image â†’ sign â†’ summary

name: Publish Images Test

on:
  push:
    branches: ['**']
    paths:
      - '**/Containerfile*'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild without cache'
        type: boolean
        default: false

permissions:
  contents: none
  packages: none
  id-token: none
  attestations: none
  security-events: none
  actions: none

concurrency:
  group: publish-images-ghcr-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  ORG: sonupreetam

jobs:
  # â”€â”€ Stage 0: Validate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate:
    name: Validate Inputs
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Validate image name formats
        run: |
          for img in "test-compass" "test-beacon-distro"; do
            echo "âœ“ Image: ${{ env.ORG }}/$img"
          done

  # â”€â”€ Stage 1: Source Scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Permissions: reusable_vuln_scan.yml needs these for ALL modes (source + image)
  scan-source:
    name: Pre-build Source Scan
    needs: [validate]
    permissions:
      contents: read          # checkout source for scanning
      packages: write         # reusable workflow's nested job requires write
      security-events: write  # upload SARIF results
      id-token: write         # OIDC for registry auth
      actions: read
    uses: sonupreetam/org-infra-tests/.github/workflows/reusable_vuln_scan.yml@main
    with:
      enable_osv: true
      enable_trivy_source: true
      enable_trivy_image: false
      trivy_severity: HIGH,CRITICAL
    secrets: inherit

  # â”€â”€ Stage 2: Build Images â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-compass:
    name: Build Compass Image
    needs: [scan-source]
    if: ${{ needs.scan-source.result == 'success' }}
    permissions:
      contents: read
      packages: write
      id-token: write
      actions: read
      attestations: write
    uses: sonupreetam/org-infra-tests/.github/workflows/reusable_push_ghcr.yml@main
    with:
      component_name: compass
      containerfile_path: compass/images/Containerfile.compass
      context_path: .
      image_name: sonupreetam/test-compass
      image_description: Test Compass service
      image_vendor: Test
      force_rebuild: ${{ inputs.force_rebuild || false }}
    secrets: inherit

  build-beacon-distro:
    name: Build Beacon Distro Image
    needs: [scan-source]
    if: ${{ needs.scan-source.result == 'success' }}
    permissions:
      contents: read
      packages: write
      id-token: write
      actions: read
      attestations: write
    uses: sonupreetam/org-infra-tests/.github/workflows/reusable_push_ghcr.yml@main
    with:
      component_name: beacon-distro
      containerfile_path: beacon-distro/Containerfile.collector
      context_path: ./beacon-distro
      image_name: sonupreetam/test-beacon-distro
      image_description: Test Beacon Distro collector
      image_vendor: Test
      force_rebuild: ${{ inputs.force_rebuild || false }}
    secrets: inherit

  # â”€â”€ Stage 3: Image Scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Permissions: same as scan-source (reusable workflow needs superset)
  scan-compass:
    name: Scan Compass Image
    needs: [build-compass]
    if: ${{ needs.build-compass.result == 'success' }}
    permissions:
      contents: read          # reusable may checkout for config
      packages: write         # pull image from GHCR
      security-events: write  # upload SARIF results
      id-token: write         # OIDC for registry auth
      actions: read           # required by osv_scanner nested job
    uses: sonupreetam/org-infra-tests/.github/workflows/reusable_vuln_scan.yml@main
    with:
      enable_osv: false
      enable_trivy_source: false
      enable_trivy_image: true
      image_ref: ${{ needs.build-compass.outputs.image }}:sha-${{ github.sha }}
      image_digest: ${{ needs.build-compass.outputs.digest }}
      trivy_severity: HIGH,CRITICAL
    secrets: inherit

  scan-beacon-distro:
    name: Scan Beacon Distro Image
    needs: [build-beacon-distro]
    if: ${{ needs.build-beacon-distro.result == 'success' }}
    permissions:
      contents: read          # reusable may checkout for config
      packages: write         # pull image from GHCR
      security-events: write  # upload SARIF results
      id-token: write         # OIDC for registry auth
      actions: read           # required by osv_scanner nested job
    uses: sonupreetam/org-infra-tests/.github/workflows/reusable_vuln_scan.yml@main
    with:
      enable_osv: false
      enable_trivy_source: false
      enable_trivy_image: true
      image_ref: ${{ needs.build-beacon-distro.outputs.image }}:sha-${{ github.sha }}
      image_digest: ${{ needs.build-beacon-distro.outputs.digest }}
      trivy_severity: HIGH,CRITICAL
    secrets: inherit

  # â”€â”€ Stage 4: Sign Images â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sign-compass:
    needs: [build-compass, scan-compass]
    if: ${{ needs.build-compass.result == 'success' && needs.scan-compass.result == 'success' }}
    permissions:
      packages: write
      id-token: write
    uses: sonupreetam/org-infra-tests/.github/workflows/reusable_sign_and_verify.yml@main
    with:
      image_name: ${{ needs.build-compass.outputs.image }}
      digest: ${{ needs.build-compass.outputs.digest }}
      allowed_identity_regex: https://github.com/sonupreetam/org-infra-tests(/.*)?
    secrets: inherit

  sign-beacon-distro:
    name: Sign Beacon Distro Image
    needs: [build-beacon-distro, scan-beacon-distro]
    if: ${{ needs.build-beacon-distro.result == 'success' && needs.scan-beacon-distro.result == 'success' }}
    permissions:
      packages: write
      id-token: write
    uses: sonupreetam/org-infra-tests/.github/workflows/reusable_sign_and_verify.yml@main
    with:
      image_name: ${{ needs.build-beacon-distro.outputs.image }}
      digest: ${{ needs.build-beacon-distro.outputs.digest }}
      allowed_identity_regex: https://github.com/sonupreetam/org-infra-tests(/.*)?
    secrets: inherit

  # â”€â”€ Stage 5: Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  summary:
    name: Pipeline Summary
    needs: [scan-source, build-compass, build-beacon-distro, scan-compass, scan-beacon-distro, sign-compass, sign-beacon-distro]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Generate Summary
        env:
          R_SRC: ${{ needs.scan-source.result }}
          R_B1: ${{ needs.build-compass.result }}
          R_B2: ${{ needs.build-beacon-distro.result }}
          R_S1: ${{ needs.scan-compass.result }}
          R_S2: ${{ needs.scan-beacon-distro.result }}
          R_G1: ${{ needs.sign-compass.result }}
          R_G2: ${{ needs.sign-beacon-distro.result }}
        run: |
          icon() { case "$1" in success) echo "âœ…";; skipped) echo "â­ï¸";; *) echo "âŒ";; esac; }
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸš€ Image Pipeline Summary
          
          | Stage | Compass | Beacon Distro |
          |-------|---------|---------------|
          | Source Scan | $(icon $R_SRC) | $(icon $R_SRC) |
          | Build | $(icon $R_B1) | $(icon $R_B2) |
          | Image Scan | $(icon $R_S1) | $(icon $R_S2) |
          | Sign | $(icon $R_G1) | $(icon $R_G2) |
          EOF
          if [[ "$R_B1" != "success" && "$R_B1" != "skipped" ]] || \
             [[ "$R_B2" != "success" && "$R_B2" != "skipped" ]]; then
            echo "âš ï¸ **One or more components failed.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "âœ… **Pipeline completed successfully.**" >> $GITHUB_STEP_SUMMARY
